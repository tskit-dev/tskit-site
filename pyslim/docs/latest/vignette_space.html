
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Vignette: A spatial simulation &#8212; PySLiM manual</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'vignette_space';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Vignette: Following up with more coalescent simulation" href="vignette_continuing.html" />
    <link rel="prev" title="Tutorial" href="tutorial.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <script data-goatcounter="https://tskit.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="introduction.html">
  
  
  
  
  
  
    <p class="title logo__title">pyslim<br/>
version 1.1.0
</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>

<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Using pyslim</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Vignette: A spatial simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="vignette_continuing.html">Vignette: Following up with more coalescent simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="vignette_coalescent_diversity.html">Vignette: Starting with diversity generated by coalescent simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="vignette_parallel_phylo.html">Vignette: Parallelizing SLiM simulations in a phylogenetic tree</a></li>
<li class="toctree-l1"><a class="reference internal" href="time_units.html">Time units</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="previous_versions.html">Migrating from previous versions of pyslim</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">pyslim reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="python_api.html">Python API</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/vignette_space.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Vignette: A spatial simulation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulation">Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recapitation-and-mutation">Recapitation and mutation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#take-a-sample-of-individuals">Take a sample of individuals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-locations">Plotting locations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#isolation-by-distance">Isolation by distance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vcf-output">VCF output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-information">More information</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-about-simplification">What about simplification?</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="vignette-a-spatial-simulation">
<span id="sec-vignette-space"></span><h1>Vignette: A spatial simulation<a class="headerlink" href="#vignette-a-spatial-simulation" title="Link to this heading">#</a></h1>
<p>Here we’ll talk through a typical workflow with pyslim,
which will:</p>
<ol class="arabic simple">
<li><p>Simulate data with SLiM, remembering some ancestral individuals.</p></li>
<li><p>Recapitate and mutate.</p></li>
<li><p>Take a subsample of the modern and ancestral individuals.</p></li>
<li><p>Get these individual locations and make a map.</p></li>
<li><p>Compute divergences between individuals, and plot against geographic distance.</p></li>
<li><p>Write out a VCF file of these individuals’ genotypes and other data for use by other programs.</p></li>
</ol>
<section id="simulation">
<h2>Simulation<a class="headerlink" href="#simulation" title="Link to this heading">#</a></h2>
<p>Here is a simple spatial SLiM recipe that simulates 1000 individuals on a spatial landscape.
The focus of this vignette is not on SLiM, so we won’t go into detail here.
Here are notes:</p>
<ol class="arabic simple">
<li><p>It does not have <em>any</em> mutations: we’ll add these on afterwards.</p></li>
<li><p>There is local fecundity regulation of population density: individuals with more neighbors
have fewer offspring.</p></li>
<li><p>We run the simulation for 2000 time steps, and “remember” everyone who is alive at time step 1000.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">initialize</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">initializeSLiMModelType</span><span class="p">(</span><span class="s2">&quot;nonWF&quot;</span><span class="p">);</span>
   <span class="n">initializeSLiMOptions</span><span class="p">(</span><span class="n">dimensionality</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span><span class="p">);</span>
   <span class="n">initializeTreeSeq</span><span class="p">();</span>
   <span class="n">initializeMutationRate</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
   <span class="n">initializeMutationType</span><span class="p">(</span><span class="s2">&quot;m1&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
   <span class="n">initializeGenomicElementType</span><span class="p">(</span><span class="s2">&quot;g1&quot;</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
   <span class="n">initializeGenomicElement</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e8</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
   <span class="n">initializeRecombinationRate</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">);</span>    

   <span class="n">defineConstant</span><span class="p">(</span><span class="s2">&quot;LAMBDA&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span> <span class="o">//</span> <span class="n">birth</span> <span class="n">rate</span>
   <span class="n">defineConstant</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>      <span class="o">//</span> <span class="n">carrying</span> <span class="n">capacity</span> <span class="n">per</span> <span class="n">unit</span> <span class="n">area</span>
   <span class="n">defineConstant</span><span class="p">(</span><span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="mi">35</span><span class="p">);</span>      <span class="o">//</span> <span class="n">width</span> <span class="ow">and</span> <span class="n">height</span> <span class="n">of</span> <span class="n">the</span> <span class="n">area</span>
   <span class="n">defineConstant</span><span class="p">(</span><span class="s2">&quot;MU&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>     <span class="o">//</span> <span class="n">death</span> <span class="n">rate</span>
   <span class="n">defineConstant</span><span class="p">(</span><span class="s2">&quot;SIGMA&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>  <span class="o">//</span> <span class="n">interaction</span> <span class="n">distance</span>
   
   <span class="o">//</span> <span class="n">spatial</span> <span class="n">interaction</span> <span class="k">for</span> <span class="n">local</span> <span class="n">competition</span>
   <span class="n">initializeInteractionType</span><span class="p">(</span><span class="s2">&quot;i1&quot;</span><span class="p">,</span> <span class="s2">&quot;xy&quot;</span><span class="p">,</span> <span class="n">reciprocal</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
                             <span class="n">maxDistance</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">SIGMA</span><span class="p">);</span>
   <span class="n">i1</span><span class="o">.</span><span class="n">setInteractionFunction</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">PI</span><span class="o">*</span><span class="n">SIGMA</span><span class="o">^</span><span class="mi">2</span><span class="p">),</span> <span class="n">SIGMA</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">reproduction</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">neighbor_density</span> <span class="o">=</span> <span class="n">i1</span><span class="o">.</span><span class="n">localPopulationDensity</span><span class="p">(</span><span class="n">individual</span><span class="p">);</span>
   <span class="n">num_offspring</span> <span class="o">=</span> <span class="n">rpois</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">LAMBDA</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">neighbor_density</span> <span class="o">/</span> <span class="n">K</span><span class="p">));</span>
   <span class="n">mate</span> <span class="o">=</span> <span class="n">i1</span><span class="o">.</span><span class="n">drawByStrength</span><span class="p">(</span><span class="n">individual</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>  <span class="o">//</span> <span class="n">single</span> <span class="n">mating</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">mate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">seqLen</span><span class="p">(</span><span class="n">num_offspring</span><span class="p">))</span> <span class="p">{</span>
           <span class="n">offspring</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">addCrossed</span><span class="p">(</span><span class="n">individual</span><span class="p">,</span> <span class="n">mate</span><span class="p">);</span>
           <span class="n">pos</span> <span class="o">=</span> <span class="n">individual</span><span class="o">.</span><span class="n">spatialPosition</span> <span class="o">+</span> <span class="n">rnorm</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIGMA</span><span class="p">);</span>
           <span class="n">offspring</span><span class="o">.</span><span class="n">setSpatialPosition</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">pointReflected</span><span class="p">(</span><span class="n">pos</span><span class="p">));</span>
       <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="mi">1</span> <span class="n">early</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">sim</span><span class="o">.</span><span class="n">addSubpop</span><span class="p">(</span><span class="s2">&quot;p1&quot;</span><span class="p">,</span> <span class="n">K</span> <span class="o">*</span> <span class="n">W</span> <span class="o">*</span> <span class="n">W</span><span class="p">);</span>
   <span class="n">p1</span><span class="o">.</span><span class="n">setSpatialBounds</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">W</span><span class="p">));</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">ind</span> <span class="ow">in</span> <span class="n">p1</span><span class="o">.</span><span class="n">individuals</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">ind</span><span class="o">.</span><span class="n">setSpatialPosition</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">pointUniform</span><span class="p">());</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="n">early</span><span class="p">()</span> <span class="p">{</span> <span class="o">//</span> <span class="n">survival</span> <span class="n">probabilities</span>
   <span class="n">p1</span><span class="o">.</span><span class="n">fitnessScaling</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">MU</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">late</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">i1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">subpopulations</span><span class="p">);</span>
<span class="p">}</span>

<span class="mi">1000</span> <span class="n">late</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">sim</span><span class="o">.</span><span class="n">treeSeqRememberIndividuals</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">individuals</span><span class="p">);</span>
<span class="p">}</span>

<span class="mi">2000</span> <span class="n">late</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">sim</span><span class="o">.</span><span class="n">treeSeqOutput</span><span class="p">(</span><span class="s2">&quot;spatial_sim.trees&quot;</span><span class="p">);</span>
   <span class="n">catn</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">);</span>
   <span class="n">sim</span><span class="o">.</span><span class="n">simulationFinished</span><span class="p">();</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
slim -s 23 vignette_space.slim
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>// Initial random seed:
23

// RunInitializeCallbacks():
initializeSLiMModelType(modelType = &#39;nonWF&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>);
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>initializeSLiMOptions(dimensionality = &#39;xy&#39;);
initializeTreeSeq();
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>initializeMutationRate(0);
initializeMutationType(1, 0.5, &quot;f&quot;, 0);
initializeGenomicElementType(1, m
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1, 1);
initializeGenomicElement(g1, 0, 99999999);
initializeRecombinationRate(1e-08);
initializeInte
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ractionType(1, &quot;xy&quot;, reciprocal=T, maxDistance=3);

// Starting run at tick &lt;start&gt;:
1 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done.
</pre></div>
</div>
</div>
</div>
<p>Ok, now let’s have a quick look at the output:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tskit</span>
<span class="n">slim_ts</span> <span class="o">=</span> <span class="n">tskit</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;spatial_sim.trees&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The tree sequence has </span><span class="si">{</span><span class="n">slim_ts</span><span class="o">.</span><span class="n">num_trees</span><span class="si">}</span><span class="s2"> trees</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="sa">f</span><span class="s2">&quot;on a genome of length </span><span class="si">{</span><span class="n">slim_ts</span><span class="o">.</span><span class="n">sequence_length</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slim_ts</span><span class="o">.</span><span class="n">num_individuals</span><span class="si">}</span><span class="s2"> individuals, </span><span class="si">{</span><span class="n">slim_ts</span><span class="o">.</span><span class="n">num_samples</span><span class="si">}</span><span class="s2"> &#39;sample&#39; genomes,</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="sa">f</span><span class="s2">&quot;and </span><span class="si">{</span><span class="n">slim_ts</span><span class="o">.</span><span class="n">num_mutations</span><span class="si">}</span><span class="s2"> mutations.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The tree sequence has 26272 trees
on a genome of length 100000000.0,
1855 individuals, 3710 &#39;sample&#39; genomes,
and 0 mutations.
</pre></div>
</div>
</div>
</div>
<p>It makes sense we have no mutations: we haven’t added any yet.
The tree sequence is recording the relationship between 5,424 genomes (the “samples”),
which requires 37,095 distinct trees along the genome.
Individuals are diploid, which explains why the number of individuals
is equal to half the number of samples.
Let’s have a look at how old those individuals are,
by tabulating when they were born:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">individual_times</span> <span class="o">=</span> <span class="n">slim_ts</span><span class="o">.</span><span class="n">individuals_time</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">individual_times</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">individual_times</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="si">}</span><span class="s2"> individuals from time </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 466 individuals from time 0.0.
There are 214 individuals from time 1.0.
There are 114 individuals from time 2.0.
There are 47 individuals from time 3.0.
There are 38 individuals from time 4.0.
There are 15 individuals from time 5.0.
There are 11 individuals from time 6.0.
There are 5 individuals from time 7.0.
There are 2 individuals from time 8.0.
There are 1 individuals from time 9.0.
There are 466 individuals from time 1000.0.
There are 239 individuals from time 1001.0.
There are 113 individuals from time 1002.0.
There are 70 individuals from time 1003.0.
There are 25 individuals from time 1004.0.
There are 18 individuals from time 1005.0.
There are 8 individuals from time 1006.0.
There are 2 individuals from time 1007.0.
There are 1 individuals from time 1008.0.
</pre></div>
</div>
</div>
</div>
<p>These “times” record the birth times of each individual.
These are <em>tskit</em> times, which are in units of “time ago”,
so for instance, there are 343 individuals born one time unit before the end of the simulation
and 167 born two time units before the end of the simulation.
(This confusing choice of units is because tskit was developed for msprime, a coalescent simulator.)
This also tells us that there’s a bunch of individuals born around 1000 time steps ago,
when we asked SLiM to Remember everyone alive at the time,
and some more in the past few time steps, i.e., the present.
This is a non-Wright-Fisher simulation,
and so individuals may live for more than one time step (even up to age 10, it seems).
Let’s check that all these individuals are alive at either (a) today or (b) 1000 time steps ago.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]:</span>
  <span class="n">alive</span> <span class="o">=</span> <span class="n">pyslim</span><span class="o">.</span><span class="n">individuals_alive_at</span><span class="p">(</span><span class="n">slim_ts</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There were </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">alive</span><span class="p">)</span><span class="si">}</span><span class="s2"> individuals alive </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> time steps in the past.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There were 913 individuals alive 0 time steps in the past.
There were 942 individuals alive 1000 time steps in the past.
</pre></div>
</div>
</div>
</div>
<p>And, 1242 + 1255 is 2497, the total number of individuals.
So, this all checks out.</p>
</section>
<section id="recapitation-and-mutation">
<h2>Recapitation and mutation<a class="headerlink" href="#recapitation-and-mutation" title="Link to this heading">#</a></h2>
<p>Next, we want to (a) simulate some ancestral diversity and (b) add in neutral mutations.
Please see <a class="reference external" href="https://onlinelibrary.wiley.com/doi/abs/10.1111/1755-0998.12968%3E">Haller et al (2019)</a>
for the why and how of these steps.
But, first let’s see if recapitation is necessary:
on how much of the genome is the tree sequence not coalesced?
In other words, recapitation adds diversity present in the initial generation;
will it make a difference?
In fact, <em>no</em> segments of the genome have coalesced:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of trees with only one root: </span><span class="si">{</span><span class="nb">sum</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">num_roots</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">slim_ts</span><span class="o">.</span><span class="n">trees</span><span class="p">()])</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="sa">f</span><span class="s2">&quot;Number with more than one root: </span><span class="si">{</span><span class="nb">sum</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">num_roots</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">slim_ts</span><span class="o">.</span><span class="n">trees</span><span class="p">()])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of trees with only one root: 0
Number with more than one root: 26272
</pre></div>
</div>
</div>
</div>
<p>Next, we will:</p>
<ol class="arabic simple">
<li><p>Recapitate, running a coalescent simulation to build ancestral trees.</p></li>
<li><p>Mutate, adding neutral variation.</p></li>
<li><p>Save the resulting tree sequence to disk for future use.</p></li>
</ol>
<p>We <em>won’t</em> simplify, since we may as well keep around all the information.
But, if we did (e.g., if we were running a large number of simulations),
we would need to pass <code class="docutils literal notranslate"><span class="pre">keep_input_roots=True</span></code> to allow recapitation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The units of time in the tree sequence are SLiM’s “time steps”, and
so are not necessarily equal to the mean generation time in a
non-Wright-Fisher model. Per-generation rates need to be divided by the
mean generation time, which can be measured in SLiM.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">recap_ts</span> <span class="o">=</span> <span class="n">pyslim</span><span class="o">.</span><span class="n">recapitate</span><span class="p">(</span><span class="n">slim_ts</span><span class="p">,</span> <span class="n">recombination_rate</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">ancestral_Ne</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">msprime</span><span class="o">.</span><span class="n">sim_mutations</span><span class="p">(</span>
         <span class="n">recap_ts</span><span class="p">,</span>
         <span class="n">rate</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
         <span class="n">model</span><span class="o">=</span><span class="n">msprime</span><span class="o">.</span><span class="n">SLiMMutationModel</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
         <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ts</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s2">&quot;spatial_sim.recap.trees&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The tree sequence now has </span><span class="si">{</span><span class="n">ts</span><span class="o">.</span><span class="n">num_trees</span><span class="si">}</span><span class="s2"> trees,</span><span class="se">\n</span><span class="s2">&quot;</span>
       <span class="sa">f</span><span class="s2">&quot; and </span><span class="si">{</span><span class="n">ts</span><span class="o">.</span><span class="n">num_mutations</span><span class="si">}</span><span class="s2"> mutations.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/work/tskit-site/tskit-site/.venv/lib/python3.11/site-packages/msprime/ancestry.py:1290: TimeUnitsMismatchWarning: The initial_state has time_units=ticks but time is measured in generations in msprime. This may lead to significant discrepancies between the timescales. If you wish to suppress this warning, you can use, e.g., warnings.simplefilter(&#39;ignore&#39;, msprime.TimeUnitsMismatchWarning)
  sim = _parse_sim_ancestry(
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The tree sequence now has 33038 trees,
 and 68325 mutations.
</pre></div>
</div>
</div>
</div>
<p>See <a class="reference internal" href="tutorial.html#sec-tutorial-adding-neutral-mutations"><span class="std std-ref">Adding neutral mutations to a SLiM simulation</span></a> for discussion of the options to
<a class="reference external" href="https://tskit.dev/msprime/docs/stable/api.html#msprime.sim_mutations" title="(in Project name not set)"><code class="xref py py-func docutils literal notranslate"><span class="pre">msprime.sim_mutations()</span></code></a>.</p>
<p>We will have no further use for <code class="docutils literal notranslate"><span class="pre">slim_ts</span></code> or for <code class="docutils literal notranslate"><span class="pre">recap_ts</span></code>;
we’ve just given them separate names for tidyness.
And, since the original SLiM mutation had no mutations, we didn’t need to specify <code class="docutils literal notranslate"><span class="pre">keep=True</span></code>
in <a class="reference external" href="https://tskit.dev/msprime/docs/stable/api.html#msprime.sim_mutations" title="(in Project name not set)"><code class="xref py py-func docutils literal notranslate"><span class="pre">sim_mutations</span></code></a>, but if we <em>had</em> put down selected mutations with SLiM
we’d probably want to keep them around.</p>
</section>
<section id="take-a-sample-of-individuals">
<h2>Take a sample of individuals<a class="headerlink" href="#take-a-sample-of-individuals" title="Link to this heading">#</a></h2>
<p>Now it’s time to compute some things.
In real life we don’t get to work with <em>everyone</em> usually,
so we’ll take a subset of individuals.
The range we have simulated has width and height 35 units,
with a population density of around 1 per unit area.
We’ll get genomes to work with by pulling out</p>
<ol class="arabic simple">
<li><p>All the modern individuals in the five squares of width 5 in the corners of the range
and the center, and</p></li>
<li><p>Five individuals sampled randomly from everyone alive 1000 time steps ago.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span>

<span class="n">alive</span> <span class="o">=</span> <span class="n">pyslim</span><span class="o">.</span><span class="n">individuals_alive_at</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">locs</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">individuals_location</span><span class="p">[</span><span class="n">alive</span><span class="p">,</span> <span class="p">:]</span>

<span class="n">W</span> <span class="o">=</span> <span class="mi">35</span>
<span class="n">w</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;topleft&#39;</span> <span class="p">:</span> <span class="n">alive</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">locs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">,</span> <span class="n">locs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">)],</span>
  <span class="s1">&#39;topright&#39;</span> <span class="p">:</span> <span class="n">alive</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">locs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">,</span> <span class="n">locs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">W</span> <span class="o">-</span> <span class="n">w</span><span class="p">)],</span>
  <span class="s1">&#39;bottomleft&#39;</span> <span class="p">:</span> <span class="n">alive</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">locs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">W</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="n">locs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">)],</span>
  <span class="s1">&#39;bottomright&#39;</span> <span class="p">:</span> <span class="n">alive</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">locs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">W</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="n">locs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">W</span> <span class="o">-</span> <span class="n">w</span><span class="p">)],</span>
  <span class="s1">&#39;center&#39;</span> <span class="p">:</span> <span class="n">alive</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">locs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">W</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">locs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">W</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>
  <span class="p">}</span>

<span class="n">old_ones</span> <span class="o">=</span> <span class="n">pyslim</span><span class="o">.</span><span class="n">individuals_alive_at</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">groups</span><span class="p">[</span><span class="s1">&#39;ancient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">old_ones</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="si">}</span><span class="s2"> individuals in the </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> group.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>We have 11 individuals in the topleft group.
We have 20 individuals in the topright group.
We have 9 individuals in the bottomleft group.
We have 19 individuals in the bottomright group.
We have 27 individuals in the center group.
We have 5 individuals in the ancient group.
</pre></div>
</div>
</div>
</div>
<p>To keep names associated with each subset of individuals,
we’ve kept the individuals in a dict, so that for instance
<code class="docutils literal notranslate"><span class="pre">groups[&quot;topleft&quot;]</span></code> is an array of all the individual IDs that are in the top left corner.
The IDs of the ancient individuals we will work with are kept in the array <code class="docutils literal notranslate"><span class="pre">ancient</span></code>.</p>
<p>Let’s do a quick consistency check, that everyone in <code class="docutils literal notranslate"><span class="pre">ancient</span></code> was actually born around 1000 time steps ago:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="s2">&quot;ancient&quot;</span><span class="p">]:</span>
  <span class="n">ind</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">individual</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
  <span class="c1"># TODO: will work on next tskit release</span>
  <span class="c1"># assert(ind.time &gt;= 1000 and ind.time &lt; 1020)</span>
  <span class="n">time</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">time</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">time</span> <span class="o">&gt;=</span> <span class="mi">1000</span> <span class="ow">and</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="mi">1020</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>No errors occurred, so that checks out.</p>
</section>
<section id="plotting-locations">
<h2>Plotting locations<a class="headerlink" href="#plotting-locations" title="Link to this heading">#</a></h2>
<p>We should check this: plot where these individuals lie
relative to everyone else.
The individuals locations are available as a property of individuals,
but to make things easier, it’s also present in a <code class="docutils literal notranslate"><span class="pre">num_individuals</span> <span class="pre">x</span> <span class="pre">3</span></code>
numpy array as <code class="docutils literal notranslate"><span class="pre">ts.individuals_location</span></code>.
(There are three columns because SLiM allows for
<code class="docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">y,</span> <span class="pre">z)</span></code> coordinates, but we’ll just use the first two.)
Since <code class="docutils literal notranslate"><span class="pre">groups[&quot;topleft&quot;]</span></code> is an array of individual IDs,
we can pull out the locations of the “topleft” individuals
by indexing the rows of the individual location array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Locations:&quot;</span><span class="p">)</span>
<span class="n">all_locs</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">individuals_location</span>
<span class="nb">print</span><span class="p">(</span><span class="n">all_locs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shape:&quot;</span><span class="p">)</span>
<span class="n">all_locs</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;topleft locations shape:&quot;</span><span class="p">)</span>
<span class="n">all_locs</span><span class="p">[</span><span class="n">groups</span><span class="p">[</span><span class="s2">&quot;topleft&quot;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Locations:
[[28.40032733  2.58533787  0.        ]
 [ 5.78241438 28.77045728  0.        ]
 [ 3.78000544 17.78078584  0.        ]
 ...
 [ 1.58145262 28.20359939  0.        ]
 [18.95359265  0.03636026  0.        ]
 [15.34433366  3.81005504  0.        ]]
shape:
topleft locations shape:
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(11, 3)
</pre></div>
</div>
</div>
</div>
<p>Using this, we can easily plot the locations of all the individuals from today
(on the left) and 1000 time steps ago (on the right).
We have to do a bit of mucking around to set the colors so that they reflect
which group each individual is in.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">group_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;topleft&#39;</span><span class="p">,</span> <span class="s1">&#39;topright&#39;</span><span class="p">,</span> <span class="s1">&#39;bottomleft&#39;</span><span class="p">,</span> <span class="s1">&#39;bottomright&#39;</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;ancient&#39;</span><span class="p">]</span>
<span class="n">ind_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">num_individuals</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_order</span><span class="p">):</span>
  <span class="n">ind_colors</span><span class="p">[</span><span class="n">groups</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">j</span>

<span class="n">old_locs</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">individuals_location</span><span class="p">[</span><span class="n">old_ones</span><span class="p">,</span> <span class="p">:]</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;today&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">locs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">locs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">ind_colors</span><span class="p">[</span><span class="n">alive</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;long ago&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">old_locs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">old_locs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">ind_colors</span><span class="p">[</span><span class="n">old_ones</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/70131945632475392514cc85a1b05b5a7f105c10b93926e1a1dfb95e997e9753.png" src="_images/70131945632475392514cc85a1b05b5a7f105c10b93926e1a1dfb95e997e9753.png" />
</div>
</div>
</section>
<section id="isolation-by-distance">
<h2>Isolation by distance<a class="headerlink" href="#isolation-by-distance" title="Link to this heading">#</a></h2>
<p>Now, let’s look at <em>isolation by distance</em>, i.e.,
let’s compare geographic and genetic distances.
Here, “genetic distance” will be mean pairwise sequence divergence.
First, we’ll compute mean genetic distance between each of our five groups.</p>
<p>The first thing we need to do is some bookkeeping.
So far, we’ve just worked with <em>individuals</em>,
but tree sequence tools, in particular the statistics computation methods from tskit,
are designed to work with <em>genomes</em>, also known as “nodes”.
So, first we need to pull out the <em>node IDs</em> corresponding to the individuals we want.
The things that make up a tree sequence - individuals, nodes, mutations, etcetera -
can generally be examined individually.
For instance, here’s what we have for the the first “ancient” individual:</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">individual</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;ancient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Individual(id=np.int64(1508), flags=131072, location=array([24.36166567, 22.53353651,  0.        ]), parents=array([1328, 1208], dtype=int32), nodes=array([7869, 7870], dtype=int32), metadata={
    &#39;pedigree_id&#39;: 961804,
    &#39;pedigree_p1&#39;: 961312,
    &#39;pedigree_p2&#39;: 960784,
    &#39;age&#39;: 0,
    &#39;subpopulation&#39;: 1,
    &#39;sex&#39;: -1,
    &#39;flags&#39;: 0
   })
</pre></div>
</div>
</div>
</div>
<p>Notice that among other things, each individual carries around a list of their node IDs,
i.e., their genomes.
We need to put these all in a list of lists,
so that, for instance, the first element of the list will have the node IDs of all the genomes
of the individuals in the “topleft” group.
And, since we kept the individual IDs in a dict, which are unordered,
we’ll have to do some extra work to make sure we keep track of order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sampled_nodes</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">]</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_order</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
     <span class="n">sampled_nodes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">individual</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s do a consistency check: the number of nodes in each element of this list
should be twice the number of individuals in the corresponding list.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">])</span>
<span class="nb">print</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">sampled_nodes</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[11, 20, 9, 19, 27, 5]
[22, 40, 18, 38, 54, 10]
</pre></div>
</div>
</div>
</div>
<p>For instance, in the ‘topleft’ corner there are 12 diploids,
with 24 nodes. That checks out.</p>
<p>Now, we can compute the matrix of pairwise mean sequence divergences
between and within these sets.
This is done using the <a class="reference external" href="https://tskit.dev/tskit/docs/stable/python-api.html#tskit.TreeSequence.divergence" title="(in Project name not set)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ts.divergence</span></code></a> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">group_div</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">divergence</span><span class="p">(</span><span class="n">sampled_nodes</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="n">pairs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_order</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_order</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">group_div</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">7</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	topleft	topright	bottomleft	bottomright	center	ancient
topleft:	2.57e-05	4.97e-05	5.2e-05	5.27e-05	5.1e-05	5.31e-05
topright:	4.97e-05	1.84e-05	5.29e-05	4.8e-05	4.81e-05	5.22e-05
bottomleft:	5.2e-05	5.29e-05	3.23e-05	4.95e-05	4.8e-05	5.3e-05
bottomright:	5.27e-05	4.8e-05	4.95e-05	3.04e-05	4.86e-05	5.33e-05
center:	5.1e-05	4.81e-05	4.8e-05	4.86e-05	4.21e-05	5.33e-05
ancient:	5.31e-05	5.22e-05	5.3e-05	5.33e-05	5.33e-05	4.24e-05
</pre></div>
</div>
</div>
</div>
<p>That’s nice, but to look at isolation by distance,
we should actually separate out the individuals.
To do that, we need to create a list of lists of nodes
whose j-th entry is the nodes belonging to the j-th individual,
and to keep track of which group each one belongs to.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ind_nodes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ind_group</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ind_ids</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_order</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
     <span class="n">ind_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
     <span class="n">ind_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">individual</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
     <span class="n">ind_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_order</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

<span class="n">nind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_ids</span><span class="p">)</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">nind</span><span class="p">)]</span>
<span class="n">ind_div</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">divergence</span><span class="p">(</span><span class="n">ind_nodes</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="n">pairs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here we’ve only computed divergences in the <em>upper triangle</em> of the pairwise divergence matrix,
with heterozygosities on the diagonal.
We’ll also need pairwise geographic distances:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">geog_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">))</span>
<span class="n">locs</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">individuals_location</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
  <span class="n">geog_dist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">locs</span><span class="p">[</span><span class="n">ind_ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                     <span class="o">-</span> <span class="n">locs</span><span class="p">[</span><span class="n">ind_ids</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
                 <span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s check that makes sense: distances of individuals from themselves should be zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">geog_dist</span><span class="p">):</span>
 <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
   <span class="k">assert</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Python does not complain, which is good.
Now let’s plot genetic distance against geographic distance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pair_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">))</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">ind_group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ancient&quot;</span> <span class="ow">or</span> <span class="n">ind_group</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ancient&quot;</span><span class="p">:</span>
     <span class="n">pair_colors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">geog_dist</span><span class="p">,</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="n">ind_div</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
          <span class="n">c</span><span class="o">=</span><span class="n">pair_colors</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;geographic distance&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;genetic distance (diffs/Kb)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0a716b09170841af7ca83ff69e30d7d145f83c8ebc27ea9c8e117a95b318e7a9.png" src="_images/0a716b09170841af7ca83ff69e30d7d145f83c8ebc27ea9c8e117a95b318e7a9.png" />
</div>
</div>
<p>Since we multiplied <code class="docutils literal notranslate"><span class="pre">ind_div</span></code> by 1,000,
the units of genetic distance are in mean number of nucleotide differences per kilobase.
It is clear that closer samples are more closely related,
and the distinct clusters corresponding to the five sampled boxes are visible.
Furthermore, ancient samples are generally more distantly diverged.</p>
</section>
<section id="vcf-output">
<h2>VCF output<a class="headerlink" href="#vcf-output" title="Link to this heading">#</a></h2>
<p>Now we want to write out these data for analysis with other programs.
To do this, and make sure that everything stays nicely cross-referenced,
we’re going to loop through the sampled individuals, writing their information to a file,
while at the same time constructing a list of individual IDs,
whose genomes we will write out to a VCF file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">indivlist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">indivnames</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;spatial_sim_individuals.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">indfile</span><span class="p">:</span>
    <span class="n">indfile</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;vcf_label&quot;</span><span class="p">,</span> <span class="s2">&quot;tskit_id&quot;</span><span class="p">,</span> <span class="s2">&quot;slim_id&quot;</span><span class="p">]</span>
                                 <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;birth_time_ago&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">group_order</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
           <span class="n">indivlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
           <span class="n">ind</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">individual</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
           <span class="n">vcf_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tsk_</span><span class="si">{</span><span class="n">ind</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
           <span class="n">indivnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vcf_label</span><span class="p">)</span>
           <span class="n">time</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">time</span>
           <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">vcf_label</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;pedigree_id&quot;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">),</span>
                   <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
           <span class="n">indfile</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;spatial_sim_genotypes.vcf&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vcffile</span><span class="p">:</span>
   <span class="n">ts</span><span class="o">.</span><span class="n">write_vcf</span><span class="p">(</span><span class="n">vcffile</span><span class="p">,</span> <span class="n">individuals</span><span class="o">=</span><span class="n">indivlist</span><span class="p">,</span> <span class="n">individual_names</span><span class="o">=</span><span class="n">indivnames</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="more-information">
<h2>More information<a class="headerlink" href="#more-information" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>The distinction between “nodes” (i.e., genomes) and “individuals” can be confusing,
as well as the idea of “samples”.
Please see the
<a class="reference external" href="https://tskit.dev/tskit/docs/stable/data-model.html#sec-data-model" title="(in Project name not set)"><span class="xref std std-ref">the tskit data model</span></a>
for more explanation about these concepts.</p></li>
<li><p>The general interface for computing statistics (explaining, for instance, the “indexes”
argument above) is described in <a class="reference external" href="https://tskit.dev/tskit/docs/stable/stats.html#sec-stats" title="(in Project name not set)"><span class="xref std std-ref">the tskit documentation</span></a> also.</p></li>
</ol>
</section>
<section id="what-about-simplification">
<h2>What about simplification?<a class="headerlink" href="#what-about-simplification" title="Link to this heading">#</a></h2>
<p>The tree sequence we worked with here contains more information than we need,
including the first generation individuals.
If we wanted to remove this, we could have used the
<a class="reference external" href="https://tskit.dev/tskit/docs/stable/python-api.html#tskit.TreeSequence.simplify" title="(in Project name not set)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">simplify</span></code></a> method,
which reduced the tree sequence to the minimal required to record the information
about a provided set of nodes.
In the workflow above we didn’t ever <em>simplify</em> the tree sequence,
because we didn’t need to.
Because simplify reorders nodes and removes unused individuals and populations,
it requires an extra layer of bookkeeping.
Such relabeling also makes it harder to compare results across different analyses
of the same data.</p>
<p>Simplifying the tree sequence down to the nodes of the individuals
in our “groups” would not change any subsequent analysis (except perhaps
removing monomorphic sites in the VCF output),
and would speed up computation of diversity.
Since the calculation was fast already, it wasn’t worth it in this case,
but for much larger tree sequences it could be worth the extra code complexity.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="tutorial.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Tutorial</p>
      </div>
    </a>
    <a class="right-next"
       href="vignette_continuing.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Vignette: Following up with more coalescent simulation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulation">Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recapitation-and-mutation">Recapitation and mutation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#take-a-sample-of-individuals">Take a sample of individuals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-locations">Plotting locations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#isolation-by-distance">Isolation by distance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vcf-output">VCF output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-information">More information</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-about-simplification">What about simplification?</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Tskit Developers
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>